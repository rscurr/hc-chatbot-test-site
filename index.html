<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hansel Cottage Chatbot Test</title>
  <style>
    body { margin:0; font-family: sans-serif; }

    /* Floating bubble button */
    #chatbot-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #0078d7;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 9999;
    }
    #chatbot-button svg {
      width: 28px; height: 28px; fill: #fff;
    }

    /* Chat panel */
    #chatbot-panel {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 340px;
      max-height: 480px;
      display: none;
      flex-direction: column;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 2px 12px rgba(0,0,0,0.4);
      overflow: hidden;
      z-index: 9999;
    }
    #chatbot-header {
      background: #0078d7;
      color: #fff;
      padding: 10px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #chatbot-close {
      cursor: pointer;
      font-size: 18px;
    }
    #chatbot-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      font-size: 14px;
    }
    .msg { margin: 6px 0; line-height: 1.4; }
    .user { text-align: right; }
    .assistant { text-align: left; }
    .user span {
      background: #0078d7;
      color: #fff;
      padding: 6px 10px;
      border-radius: 12px;
      display: inline-block;
    }
    .assistant span {
      background: #f1f1f1;
      padding: 6px 10px;
      border-radius: 12px;
      display: inline-block;
    }

    #chatbot-input {
      display: flex;
      border-top: 1px solid #ddd;
    }
    #chatbot-text {
      flex: 1;
      border: none;
      padding: 10px;
      font-size: 14px;
      outline: none;
    }
    #chatbot-send {
      background: #0078d7;
      border: none;
      color: #fff;
      padding: 0 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="chatbot-button">
  <!-- Simple chat bubble icon -->
  <svg viewBox="0 0 24 24">
    <path d="M20 2H4a2 2 0 0 0-2 2v18l4-4h14a2 
             2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/>
  </svg>
</div>

<div id="chatbot-panel">
  <div id="chatbot-header">
    Hansel Cottage
    <span id="chatbot-close">&times;</span>
  </div>
  <div id="chatbot-messages"></div>
  <form id="chatbot-input">
    <input id="chatbot-text" type="text" placeholder="Type a message…" />
    <button id="chatbot-send" type="submit">Send</button>
  </form>
</div>

<script>
  const API_BASE = "https://hc-chatbot-backend.onrender.com";
  let sessionId = localStorage.getItem("chatbot-session-id");
  if (!sessionId) {
    sessionId = Math.random().toString(36).slice(2);
    localStorage.setItem("chatbot-session-id", sessionId);
  }

  const button = document.getElementById('chatbot-button');
  const panel = document.getElementById('chatbot-panel');
  const close = document.getElementById('chatbot-close');
  const form = document.getElementById('chatbot-input');
  const text = document.getElementById('chatbot-text');
  const messages = document.getElementById('chatbot-messages');

  button.onclick = () => panel.style.display = 'flex';
  close.onclick = () => panel.style.display = 'none';

  form.onsubmit = async (e) => {
    e.preventDefault();
    const msg = text.value.trim();
    if (!msg) return;
    addMessage(msg, 'user');
    text.value = '';

    try {
      const res = await fetch(`${API_BASE}/api/chat`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Session-Id': sessionId
        },
        body: JSON.stringify({ message: msg, conversationId: sessionId })
      });
      const data = await res.json();
      if (data.answer) addMessage(data.answer, 'assistant');
      else addMessage('⚠️ Error contacting server.', 'assistant');
    } catch (err) {
      addMessage('⚠️ Error contacting server.', 'assistant');
    }
  };

  function addMessage(text, who) {
    const div = document.createElement('div');
    div.className = `msg ${who}`;
    div.innerHTML = `<span>${escapeHtml(text)}</span>`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function escapeHtml(str) {
    return str.replace(/[&<>]/g, c =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]||c));
  }
</script>
</body>
</html>
