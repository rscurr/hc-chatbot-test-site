<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hansel Cottage – Chatbot (Test)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --hc-primary: #0078d7;
      --hc-primary-dark: #005a9e;
      --hc-bg: #ffffff;
      --hc-bot: #f1f1f1;
      --hc-user: #e8f3ff;
      --hc-text: #111827;
    }
    html, body { margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--hc-text); }

    /* Floating bubble button */
    #hc-bubble {
      position: fixed; right: 20px; bottom: 20px;
      width: 60px; height: 60px; border-radius: 999px;
      background: var(--hc-primary);
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25); cursor: pointer; z-index: 9999;
    }
    #hc-bubble svg { width: 28px; height: 28px; fill: #fff; }

    /* Panel */
    #hc-panel {
      position: fixed; right: 20px; bottom: 90px;
      width: 360px; max-height: 560px; display: none; flex-direction: column;
      background: var(--hc-bg); border-radius: 14px; overflow: hidden;
      box-shadow: 0 16px 40px rgba(0,0,0,0.25); z-index: 9999;
    }
    #hc-head {
      background: var(--hc-primary); color: #fff; padding: 10px 12px;
      display: flex; align-items: center; justify-content: space-between; font-weight: 600;
    }
    #hc-close { cursor: pointer; font-size: 20px; line-height: 1; padding: 2px 6px; }

    #hc-body { padding: 10px; overflow-y: auto; flex: 1; background: #fafafa; }

    .hc-row { margin: 8px 0; display: flex; }
    .hc-row.user { justify-content: flex-end; }
    .hc-row.bot  { justify-content: flex-start; }

    .hc-bubble {
      display: inline-block; max-width: 85%;
      padding: 8px 12px; border-radius: 14px; line-height: 1.4; font-size: 14px; white-space: pre-wrap;
    }
    .hc-bubble.user { background: var(--hc-user); }
    .hc-bubble.bot  { background: var(--hc-bot); }
    .hc-bubble.bot a { color: var(--hc-primary-dark); text-decoration: underline; font-weight: 600; }

    #hc-input {
      display: flex; gap: 6px; padding: 8px; background: #fff; border-top: 1px solid #e6e6e6;
    }
    #hc-text {
      flex: 1; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 10px; outline: none; font-size: 14px;
    }
    #hc-send {
      padding: 0 14px; background: var(--hc-primary); color: #fff; border: 0; border-radius: 10px; cursor: pointer;
    }
    #hc-send:hover { background: var(--hc-primary-dark); }

    @media (max-width: 480px) {
      #hc-panel { width: calc(100vw - 24px); right: 12px; }
    }
  </style>
</head>
<body>

<!-- Floating chat bubble -->
<div id="hc-bubble" aria-label="Open chat" title="Chat with us">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M20 2H4a2 2 0 0 0-2 2v18l4-4h14a2 
             2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/>
  </svg>
</div>

<!-- Chat panel -->
<div id="hc-panel" role="dialog" aria-label="Hansel Cottage Chat">
  <div id="hc-head">
    Hansel Cottage
    <span id="hc-close" aria-label="Close chat" title="Close">×</span>
  </div>
  <div id="hc-body"></div>
  <form id="hc-input">
    <input id="hc-text" type="text" placeholder="Type a message…" autocomplete="off" />
    <button id="hc-send" type="submit">Send</button>
  </form>
</div>

<script>
  // ✅ Use your real backend
  const API_BASE = "https://hansel-cottage.onrender.com";

  // Session (conversation) id persists across page loads
  let sessionId = localStorage.getItem("hc-session-id");
  if (!sessionId) {
    sessionId = Math.random().toString(36).slice(2);
    localStorage.setItem("hc-session-id", sessionId);
  }

  // Elements
  const $bubble  = document.getElementById('hc-bubble');
  const $panel   = document.getElementById('hc-panel');
  const $close   = document.getElementById('hc-close');
  const $body    = document.getElementById('hc-body');
  const $form    = document.getElementById('hc-input');
  const $text    = document.getElementById('hc-text');

  // Show/hide
  $bubble.addEventListener('click', () => {
    $panel.style.display = 'flex';
    $text.focus();
  });
  $close.addEventListener('click', () => {
    $panel.style.display = 'none';
  });

  // Markdown → safe HTML (links only) + line breaks
  function renderMarkdownLinks(s) {
    // basic escaping
    const esc = (s || '').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    const withLinks = esc.replace(
      /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
      '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'
    );
    return withLinks.replace(/\n/g, '<br>');
  }

  // Append bubble
  function appendBubble(text, who) {
    const row = document.createElement('div');
    row.className = `hc-row ${who}`;
    const bub = document.createElement('div');
    bub.className = `hc-bubble ${who}`;
    if (who === 'bot') {
      bub.innerHTML = renderMarkdownLinks(text);
    } else {
      bub.textContent = text;
    }
    row.appendChild(bub);
    $body.appendChild(row);
    $body.scrollTop = $body.scrollHeight;
  }

  // Typing indicator
  let typingRow = null;
  function showTyping() {
    typingRow = document.createElement('div');
    typingRow.className = 'hc-row bot';
    const bub = document.createElement('div');
    bub.className = 'hc-bubble bot';
    bub.textContent = '…';
    typingRow.appendChild(bub);
    $body.appendChild(typingRow);
    $body.scrollTop = $body.scrollHeight;
  }
  function hideTyping() {
    if (typingRow && typingRow.parentNode) typingRow.parentNode.removeChild(typingRow);
    typingRow = null;
  }

  // Submit
  $form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = ($text.value || '').trim();
    if (!msg) return;
    appendBubble(msg, 'user');
    $text.value = '';
    showTyping();

    try {
      const res = await fetch(`${API_BASE}/api/chat`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Session-Id': sessionId
        },
        body: JSON.stringify({ message: msg, conversationId: sessionId })
      });
      const data = await res.json();
      hideTyping();
      appendBubble(data.answer || '⚠️ Error contacting server.', 'bot');
    } catch (err) {
      hideTyping();
      appendBubble('⚠️ Error contacting server.', 'bot');
    }
  });

  // (Optional) Greeting on open
  appendBubble('Hi! Ask about availability, prices, or cottage info. You can also [book here](https://www.hanselcottage.com/availability).', 'bot');
</script>
</body>
</html>
